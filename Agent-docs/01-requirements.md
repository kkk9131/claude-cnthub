# 要件定義書

## プロジェクト概要

**プロジェクト名**: claude-cnthub
**目的**: Claude Code の「最適化エンジン」- セッション・システムコンテキストの可視化・操作・AI最適化

---

## ビジョン

```
lovcode:       Claude Code の「ビューア」（見るだけ）
claude-cnthub: Claude Code の「最適化エンジン」（見る + 操作 + AI最適化）
```

### 核心的価値：段階的開示（Progressive Disclosure）

```
問題: 全部最初に読み込む → コンテキスト肥大化 → 効率低下
解決: 必要な時に必要なものだけ開示 → コンテキスト最適化 → 効率向上
```

---

## 差別化ポイント

| 機能 | lovcode | claude-cnthub |
|------|---------|---------------|
| セッション閲覧 | ✅ | ✅ |
| システム設定閲覧 | ✅（手動管理） | ✅ + **AI最適化** |
| コンテキスト注入 | ❌ | ✅ |
| 最適化提案・実行 | ❌ | ✅（Agent SDK） |
| プロジェクト横断共有 | ❌ | ✅ |

---

## デプロイ形態

### ローカル専用

| 形態 | 説明 | ユースケース |
|------|------|-------------|
| **Claude Code Plugin** | `claude plugin install` でインストール | メイン利用方法 |
| **Web UI** | `http://localhost:3048` でアクセス | 統合ダッシュボード |

**公開非対応**: 認証なし、ローカル完結

### Claude Agent SDK 利用方式

| 方式 | 対象ユーザー | 設定 |
|------|-------------|------|
| **サブスクプラン** | Claude Pro/Team/Enterprise | 追加設定不要 |
| **API キー** | API 直接利用者 | ANTHROPIC_API_KEY 設定 |

---

## Phase 2: System Context 可視化

### F-SYS: システムコンテキスト管理

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F-SYS.1 | Skills 一覧表示 | 必須 | ~/.claude/commands/, .claude/commands/ |
| F-SYS.2 | Hooks 一覧表示 | 必須 | Hook 設定の可視化 |
| F-SYS.3 | MCP Servers 表示 | 必須 | settings.json から取得 |
| F-SYS.4 | Rules 表示 | 必須 | CLAUDE.md, .claude/rules/ |
| F-SYS.5 | ノードビュー統合 | 必須 | Sessions と同じ UI で表示 |
| F-SYS.6 | プロジェクト接続 | 必須 | Skill をプロジェクトにリンク |

---

## Phase 3: 最適化エージェント

### F-OPT: AI 最適化機能

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F-OPT.1 | Skills 分析 | 必須 | 重複検出、統合提案 |
| F-OPT.2 | Skills 段階的開示化 | 必須 | CLAUDE.md から分離 |
| F-OPT.3 | Hooks 効率化 | 任意 | 不要 Hook 検出、最適化提案 |
| F-OPT.4 | MCP → Skill 化 | 必須 | MCP を Skill でラップ |
| F-OPT.5 | CLAUDE.md 分割 | 必須 | 巨大ファイルを分割 |
| F-OPT.6 | 最適化プラン確認 | 必須 | 実行前にユーザー承認 |
| F-OPT.7 | ロールバック | 必須 | 変更を元に戻す |

### 最適化フロー

```
[最適化ボタン] → 調査 → プラン提示 → 承認 → 実行 → 確認
                                      ↓
                                  ロールバック可能
```

---

## Phase 4: セッションコンテキスト強化（既存機能の拡張）

### F-CTX: コンテキスト操作

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F-CTX.1 | get | 実装済 | 過去セッションから注入 |
| F-CTX.2 | export | 実装済 | 現在のやり取りを保存 |
| F-CTX.3 | プロジェクト横断検索 | 任意 | 複数プロジェクトを跨いで検索 |
| F-CTX.4 | パターン再現 | 任意 | 成功したやり取りを再現 |

---

## Phase 5: Cross-LLM 連携（将来）

### F-LLM: 他 LLM 接続

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F-LLM.1 | ChatGPT 接続 | 将来 | API Key 設定で接続 |
| F-LLM.2 | Codex 接続 | 将来 | API Key 設定で接続 |
| F-LLM.3 | コンテキスト転送 | 将来 | GUI でドラッグ&ドロップ |

---

## コマンド体系

```
/cnthub:
├── セッション操作
│   ├── get          # 過去セッションから注入
│   └── export       # 現在のやり取りを保存
│
└── 最適化
    ├── optimize           # 全体最適化（対話的）
    ├── optimize:skills    # Skills 最適化
    ├── optimize:hooks     # Hooks 最適化
    ├── optimize:mcp       # MCP → Skill 化
    └── optimize:rules     # ルール段階的開示化
```

---

## UI 要件

### 統合ダッシュボード

```
┌─────────────────────────────────────────────────────────────────┐
│  claude-cnthub                              [Sessions ▼] 切り替え│
│  ┌───────────────────────────────────────┐  ┌──────────┐        │
│  │                                       │  │ Sessions │        │
│  │  ノードビュー                          │  │ System   │        │
│  │  （Sessions / System 共通）            │  └──────────┘        │
│  │                                       │                      │
│  └───────────────────────────────────────┘                      │
│  [最適化] ← 選択したノードに対して実行                           │
└─────────────────────────────────────────────────────────────────┘
```

### 要件

| ID | 要件 | 説明 |
|----|------|------|
| UI.1 | Sessions/System 切り替え | 同一ページ内でタブ切り替え |
| UI.2 | ノードビュー統一 | セッション・システム両方を同じ形式で表示 |
| UI.3 | プロジェクト接続 | ノード間をドラッグで接続、共有を実現 |
| UI.4 | 最適化ボタン | 選択ノードに対して最適化を実行 |
| UI.5 | プログレス表示 | 最適化の進捗をリアルタイム表示 |
| UI.6 | 承認フロー | プラン確認→承認→実行 |

---

## 非機能要件

### NF1: パフォーマンス

| ID | 要件 | 目標値 |
|----|------|--------|
| NF1.1 | API レスポンス | 95% が 200ms 以内 |
| NF1.2 | 検索レスポンス | 500ms 以内 |
| NF1.3 | 最適化分析 | 60秒以内 |

### NF2: 信頼性

| ID | 要件 | 説明 |
|----|------|------|
| NF2.1 | データ永続化 | SQLite でローカル保存 |
| NF2.2 | グレースフルデグラデーション | AI 処理失敗時もセッション継続 |
| NF2.3 | ロールバック | 最適化変更を元に戻せる |

---

## 制約事項

1. **ランタイム**: Bun 1.1.0 以上
2. **AI**: Claude Agent SDK（サブスク or API キー）
3. **ストレージ**: SQLite（ローカル）
4. **ネットワーク**: ローカル専用（公開非対応）

---

## 用語定義

| 用語 | 定義 |
|------|------|
| Session | cnthub が管理する1回の作業単位 (`ch_ss_0001`) |
| System Context | Skills, Hooks, MCP, Rules の総称 |
| Progressive Disclosure | 段階的なコンテキスト開示 |
| Optimization Agent | 設定を分析・最適化する AI エージェント |

# 要件定義書

## プロジェクト概要

**プロジェクト名**: claude-cnthub
**目的**: LLM セッションの永続化・コンテキスト共有・クロスLLM連携を実現する開発支援ツール

---

## ビジョン

```
Phase 1: Claude Code Plugin
──────────────────────────────────────────────────
LLM CLI エージェント (Claude Code)
         ↓ Hooks
   セッション記録・永続化
         ↓
   段階的コンテキスト取得 (Level 0/1)
         ↓
   マージ・知識統合
         ↓
   GUI 操作 (ノード操作・検索)

Phase 2: Cross-LLM 連携
──────────────────────────────────────────────────
         ┌── Claude Code (Hooks)
         │
cnthub ──┼── ChatGPT (REST API)
         │
         └── Codex / 他 LLM (REST API)

GUI でコンテキストをドラッグ&ドロップで転送
```

---

## 背景と課題

### 現状の課題

1. Claude Code のセッションは独立しており、過去の文脈が引き継がれない
2. 複数セッションの管理が煩雑
3. 過去のセッションで学んだことを再利用できない
4. 異なる LLM 間でコンテキストを共有できない

### 解決策

- **Phase 1**: Claude Code Plugin として動作し、セッション永続化・コンテキスト注入を実現
- **Phase 2**: 他 LLM (ChatGPT, Codex 等) へのコンテキスト転送を GUI で実現

---

## デプロイ形態

### ローカル専用

| 形態 | 説明 | ユースケース |
|------|------|-------------|
| **Claude Code Plugin** | `claude plugin install` でインストール | メイン利用方法 |
| **Web UI** | `http://localhost:3048` でアクセス | セッション管理・ノード操作 |

**公開非対応**: 認証なし、ローカル完結

### Claude Agent SDK 利用方式

| 方式 | 対象ユーザー | 設定 |
|------|-------------|------|
| **サブスクプラン** | Claude Pro/Team/Enterprise | 追加設定不要 |
| **API キー** | API 直接利用者 | ANTHROPIC_API_KEY 設定 |

---

## Phase 1: Claude Code Plugin

### F1: セッション管理

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F1.1 | セッション自動記録 | 必須 | Hooks でセッション開始/終了を自動検知 |
| F1.2 | 独自セッション ID | 必須 | `ch_ss_0001` 形式で管理 |
| F1.3 | セッション一覧 | 必須 | GUI / CLI で全セッションを表示 |
| F1.4 | セッション検索 | 必須 | セマンティック検索 |
| F1.5 | リアルタイム表示 | 必須 | WebSocket でリアルタイム表示 |

### F2: セッション要約 (AI)

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F2.1 | 自動要約 | 必須 | SessionEnd 時に自動生成 |
| F2.2 | メタデータ抽出 | 必須 | 決定事項、変更ファイル、エラー修正履歴 |
| F2.3 | タグ自動抽出 | 必須 | セッション内容からタグを自動生成 |

### F3: コンテキスト注入

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F3.1 | 自動注入 | 必須 | SessionStart 時に関連コンテキスト注入 |
| F3.2 | Progressive Disclosure | 必須 | Level 0 (インデックス) → Level 1 (詳細) |
| F3.3 | 手動注入 | 任意 | Skills 経由で手動注入 |

### F4: マージ機能

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F4.1 | セッションマージ | 必須 | 複数セッションの知識を統合 |
| F4.2 | AI マージ要約 | 必須 | マージ時に AI で要約生成 |
| F4.3 | 階層マージ | 任意 | マージ済みをさらにマージ |

### F5: GUI 操作

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F5.1 | セッション一覧表示 | 必須 | カード形式で表示 |
| F5.2 | ツリービュー | 必須 | プロジェクト → セッション → マージ |
| F5.3 | ノード操作 | 必須 | ドラッグ&ドロップでマージ |
| F5.4 | 検索 UI | 必須 | セマンティック検索インターフェース |

### F6: Skills 連携

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F6.1 | cnthub:add | 必須 | メモリ追加 (Worker API 経由) |
| F6.2 | cnthub:search | 必須 | セマンティック検索 |
| F6.3 | cnthub:gui | 必須 | ブラウザで GUI を開く |

### F7: CLI (補助)

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F7.1 | `cnthub list` | 任意 | セッション一覧 |
| F7.2 | `cnthub search` | 任意 | 検索 |
| F7.3 | `cnthub merge` | 任意 | マージ実行 |

---

## Phase 2: Cross-LLM 連携

### F8: 他 LLM 接続

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F8.1 | ChatGPT 接続 | 必須 | API Key 設定で接続 |
| F8.2 | Codex 接続 | 任意 | API Key 設定で接続 |
| F8.3 | 接続管理 UI | 必須 | GUI で API Key 設定・接続状態確認 |

### F9: コンテキスト転送

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F9.1 | ノード選択 | 必須 | GUI でセッション/マージを選択 |
| F9.2 | 転送先選択 | 必須 | 転送先 LLM を選択 |
| F9.3 | コンテキスト編集 | 任意 | 転送前にコンテキストを編集 |
| F9.4 | 転送実行 | 必須 | 選択した LLM へコンテキスト送信 |

### F10: Profile System

| ID | 機能 | 優先度 | 説明 |
|----|------|--------|------|
| F10.1 | Static Facts | 必須 | 技術スタック、規約等 (他LLM向け) |
| F10.2 | Dynamic Facts | 必須 | 最近の決定事項、進行中タスク |
| F10.3 | 自動更新 | 必須 | SessionEnd 時に Dynamic Facts 更新 |

---

## 非機能要件

### NF1: パフォーマンス

| ID | 要件 | 目標値 |
|----|------|--------|
| NF1.1 | API レスポンス | 95% が 200ms 以内 |
| NF1.2 | 検索レスポンス | 500ms 以内 |
| NF1.3 | 要約生成 | 30秒以内 |

### NF2: 信頼性

| ID | 要件 | 説明 |
|----|------|------|
| NF2.1 | データ永続化 | SQLite でローカル保存 |
| NF2.2 | グレースフルデグラデーション | AI 処理失敗時もセッション継続 |

### NF3: 互換性

| ID | 要件 | 説明 |
|----|------|------|
| NF3.1 | マルチプラットフォーム | macOS / Windows / Linux |
| NF3.2 | Claude Agent SDK | サブスク/API キー両対応 |
| NF3.3 | Plugin 互換 | Claude Plugin 仕様準拠 |

---

## 制約事項

1. **ランタイム**: Bun 1.1.0 以上
2. **AI**: Claude Agent SDK（サブスク or API キー）
3. **ストレージ**: SQLite（ローカル）
4. **ネットワーク**: ローカル専用（公開非対応）

---

## 用語定義

| 用語 | 定義 |
|------|------|
| Session | cnthub が管理する1回の作業単位 (`ch_ss_0001`) |
| Observation | セッション中の観測記録（ツール使用、決定事項等） |
| Summary | AI 生成のセッション要約 |
| Merge | 複数セッションの知識統合 |
| Context Injection | 関連情報の自動注入 |
| Progressive Disclosure | 段階的なコンテキスト開示 (Level 0 → 1) |
| Profile | プロジェクトの静的/動的情報 |
| Skills | Claude の行動指針（文脈で自動ロード） |
| Hooks | Claude Code ライフサイクルイベントの捕捉 |

# 07-plugin-requirements.md - Plugin 要件定義

> 最終更新: 2026-01-02
> claude-cnthub Plugin の動作要件と設計

## 概要

Claude Code Plugin としてセッション管理・コンテキスト注入を実現する。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Claude Code CLI                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ SessionStart │  │  PostToolUse │  │     Stop     │  │  SessionEnd  │    │
│  │    Hook      │  │    Hook      │  │    Hook      │  │    Hook      │    │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘    │
└─────────┼──────────────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │                  │
          ▼                  ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Backend API (Port 3048)                            │
│                                                                             │
│   ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐        │
│   │ セッション  │   │  観測記録   │   │  (未使用)   │   │ 要約生成    │        │
│   │   登録     │   │   保存     │   │            │   │ Embedding  │        │
│   │ コンテキスト│   │            │   │            │   │   保存     │        │
│   │   注入     │   │            │   │            │   │            │        │
│   └────────────┘   └────────────┘   └────────────┘   └────────────┘        │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                    SQLite + sqlite-vec                          │      │
│   │   sessions │ observations │ summaries │ embeddings              │      │
│   └─────────────────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 要件一覧

| ID | 要件 | 優先度 |
|----|------|--------|
| R-01 | 要約生成は SessionEnd 時のみ | 高 |
| R-02 | リアルタイム観測取得 (PostToolUse Hook) | 高 |
| R-03 | UI でセッション要約を D&D で追加 | 中 |
| R-04 | SessionEnd 時に要約を生成・保存 | 高 |
| R-05 | SessionEnd → 要約 → タイトル → Embedding 連鎖生成 | 高 |
| R-06 | 検索は sqlite-vec + SQL フィルタ (軽量) | 高 |
| R-07 | SessionStart で関連セッションを検索・注入 | 高 |
| R-08 | `/cnthub:get` - 過去セッション取得コマンド | 高 |
| R-09 | `/cnthub:export` - 現在セッション書き出しコマンド | 高 |

---

## Hook 詳細設計

### セッションライフサイクル

```
claude 起動         ツール実行ごと        /stop         claude 終了
     │                   │                 │                │
     ▼                   ▼                 ▼                ▼
┌──────────┐       ┌──────────┐       ┌──────────┐    ┌──────────┐
│SessionStart│      │PostToolUse│       │   Stop   │    │SessionEnd│
└─────┬────┘       └─────┬────┘       └─────┬────┘    └─────┬────┘
      │                  │                  │               │
      ▼                  ▼                  ▼               ▼
┌──────────┐       ┌──────────┐       ┌──────────┐    ┌──────────┐
│1.セッション│       │ 観測記録  │       │ (未使用)  │    │1.要約生成 │
│  登録    │       │  保存    │       │          │    │2.タイトル │
│2.関連検索 │       │          │       │          │    │3.Embedding│
│3.注入    │       │          │       │          │    │4.DB保存   │
└──────────┘       └──────────┘       └──────────┘    └──────────┘
```

### R-01/R-04/R-05: SessionEnd 処理フロー

```
SessionEnd Hook 発火
        │
        ▼
┌─────────────────┐
│ トランスクリプト │
│    読み込み     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Claude AI で   │
│   要約生成      │ ← Claude Agent SDK (query)
│ + タイトル生成  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Embedding 生成  │ ← Transformers.js (ローカル)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   DB 保存       │
│ - summaries     │
│ - embeddings    │
└─────────────────┘
```

### R-02: PostToolUse 観測記録

```
PostToolUse Hook 発火
        │
        ├── tool_name (使用ツール名)
        ├── tool_input (入力)
        └── tool_output (出力)
                │
                ▼
┌─────────────────┐
│ API 呼び出し     │
│ POST /api/obs   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ observations    │
│ テーブルに保存   │
└─────────────────┘
```

### R-07: SessionStart コンテキスト注入

```
SessionStart Hook 発火
        │
        ├── session_id
        ├── cwd (作業ディレクトリ)
        └── transcript_path
                │
                ▼
┌─────────────────┐
│ 1. セッション登録 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. 関連セッション│
│    検索         │ ← sqlite-vec ベクトル検索
│  (cwd/project)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. 要約を stdout │
│    に出力       │ → Claude に自動注入
└─────────────────┘
```

---

## 検索設計 (R-06)

### sqlite-vec + SQL フィルタ

```sql
-- セマンティック検索 + メタデータフィルタ
SELECT
  s.session_id,
  s.name,
  sm.short_summary,
  vec_distance_cosine(e.embedding, ?) AS distance
FROM sessions s
JOIN summaries sm ON s.session_id = sm.session_id
JOIN embeddings e ON s.session_id = e.session_id
WHERE s.project_id = ?              -- プロジェクトフィルタ
  AND s.created_at > ?              -- 日付フィルタ
  AND s.status = 'completed'        -- ステータスフィルタ
ORDER BY distance ASC
LIMIT 10;
```

### 検索フロー

```
検索クエリ
    │
    ▼
┌─────────────────┐
│ Embedding 生成   │ ← Transformers.js
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ sqlite-vec      │
│ ベクトル類似検索 │
│ + SQL フィルタ  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 関連セッション   │
│ 一覧返却        │
└─────────────────┘
```

---

## UI 連携 (R-03)

### D&D でコンテキスト追加

```
┌─────────────────────────────────────────────────────────────┐
│                        GUI (Web)                            │
│                                                             │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │  セッション一覧  │  Drag   │  コンテキスト    │           │
│  │  (TreeView)     │ ──────▶ │  エリア         │           │
│  │                 │         │                 │           │
│  │ ├─ Session A    │         │  + Session A    │           │
│  │ ├─ Session B    │         │  + Session C    │           │
│  │ └─ Session C    │         │                 │           │
│  └─────────────────┘         └─────────────────┘           │
│                                      │                      │
│                                      ▼                      │
│                              コンテキスト生成               │
│                              → クリップボード               │
│                              → LLM に注入                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 技術スタック

| 項目 | 技術 |
|------|------|
| Hook 実行 | Node.js スクリプト |
| 要約生成 | Claude Agent SDK (`query`) |
| Embedding | Transformers.js (all-MiniLM-L6-v2, 384次元) |
| ベクトル検索 | sqlite-vec |
| DB | SQLite |

---

## Stop Hook について

**現状**: Stop Hook は未使用（SessionEnd に統合）

**理由**:
- `/stop` のたびに要約生成すると、セッション再開時に複雑化
- SessionEnd 時に一括で要約生成する方がシンプル

```
Stop Hook: 何もしない (将来の拡張用に残す)
SessionEnd Hook: 全ての終了処理を実行
```

---

## 未実装・優先度低

| 項目 | 理由 |
|------|------|
| CLI (cnthub コマンド) | Plugin 動作に不要 |
| GUI 統合 (UI-01〜03) | Plugin 動作に不要、後で実装 |
| Phase 2 (Cross-LLM) | 将来機能 |

---

## [追記 2026-01-02] スラッシュコマンド設計

### R-08: `/cnthub:get` - 過去セッション取得コマンド

セッション途中で過去の要約済みコンテキストを取得・注入する。

```
/cnthub:get 実行
     │
     ▼
┌─────────────────┐
│ API で検索      │
│ GET /api/sessions │
│ (status=completed) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ リスト表示      │
│ 1. [2026-01-01] 認証機能実装  │
│ 2. [2026-01-01] バグ修正      │
│ 3. [2025-12-31] リファクタリング │
│ 選択してください (複数可)     │
└────────┬────────┘
         │ ユーザー選択
         ▼
┌─────────────────┐
│ 選択セッションの │
│ 要約を取得      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ stdout に出力   │
│ → Claude に注入 │
└─────────────────┘
```

**実装場所**: `plugin/commands/cnthub-get.md`

**出力例**:
```markdown
# 関連コンテキスト

## Session: 認証機能実装 (2026-01-01)
JWT認証を実装。middleware/auth.ts を追加。
主な決定: RS256アルゴリズムを採用。

## Session: バグ修正 (2026-01-01)
トークン有効期限のバグを修正。
変更ファイル: services/auth.ts
```

---

### R-09: `/cnthub:export` - 現在セッション書き出しコマンド

現在セッションの観測データを分割・選択して要約保存する。

**前提**: R-02 (PostToolUse Hook) で観測が保存されていること

```
/cnthub:export 実行
     │
     ▼
┌─────────────────┐
│ 現在セッションの │
│ observations 取得│
│ GET /api/observations │
│ ?session=current │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Claude AI で    │
│ 論理グループに  │
│ 分割           │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ リスト表示      │
│ □ 1. 認証機能の実装 (5 observations) │
│ □ 2. テスト追加 (3 observations)    │
│ □ 3. ドキュメント更新 (2 observations) │
│ 書き出すグループを選択              │
└────────┬────────┘
         │ ユーザー選択
         ▼
┌─────────────────┐
│ 選択グループを  │
│ Claude AI で要約│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 新セッションとして │
│ DB 保存         │
│ - sessions      │
│ - summaries     │
│ - embeddings    │
└─────────────────┘
```

**実装場所**: `plugin/commands/cnthub-export.md`

**ユースケース**:
- 1つのセッションで複数の作業を行った場合に分割保存
- 重要な作業のみを抽出して保存
- 不要なコンテキスト（試行錯誤など）を除外

---

### コマンド配置

```
plugin/
├── commands/
│   ├── cnthub-get.md      # R-08: 過去セッション取得
│   └── cnthub-export.md   # R-09: 現在セッション書き出し
├── hooks/
│   └── hooks.json
└── scripts/
    └── ...
```

### 依存関係

```
R-09 (cnthub:export)
    │
    └── 依存 → R-02 (PostToolUse Hook)
                    │
                    └── observations テーブルにデータがあること
```
